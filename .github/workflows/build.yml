name: Fortran Build and Release

on:
  push:
    tags:
      - "v*" # Триггер на теги v1.0.0, v2.0.0 и т.д.

jobs:
  build-and-release:
    strategy:
      matrix:
        include:
          - platform: windows
            os: windows-latest
            artifact_name: myprogram-windows-x64.zip
            executable_name: myprogram.exe
            compile_command: gfortran *.f90 -o myprogram.exe -O2 -m64 -static
            setup_command: choco install mingw -y
            test_command: ./myprogram.exe --help || echo "Test complete"

          - platform: macos-m1
            os: macos-latest
            artifact_name: myprogram-macos-arm64.tar.gz
            executable_name: myprogram
            compile_command: $FC *.f90 -o myprogram -O2 -march=armv8-a
            setup_command: |
              brew install gcc
              echo "/opt/homebrew/bin" >> $GITHUB_PATH
              FC=$(which gfortran || find /opt/homebrew -name gfortran -type f 2>/dev/null | head -1)
            test_command: ./myprogram --help || echo "Test complete"

    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: ${{ matrix.setup_command }}

      - name: Compile Fortran
        run: ${{ matrix.compile_command }}

      - name: Test executable
        run: ${{ matrix.test_command }}

      - name: Prepare release asset
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "windows" ]; then
            7z a ${{ matrix.artifact_name }} ${{ matrix.executable_name }}
          else
            chmod +x ${{ matrix.executable_name }}
            tar -czf ${{ matrix.artifact_name }} ${{ matrix.executable_name }}
          fi

          # Создаем README
          echo "# ${{ matrix.executable_name }}" > README-${{ matrix.platform }}.txt
          echo "Platform: ${{ matrix.platform }}" >> README-${{ matrix.platform }}.txt
          echo "Built: $(date)" >> README-${{ matrix.platform }}.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-build
          path: |
            ${{ matrix.artifact_name }}
            ${{ matrix.executable_name }}
            README-${{ matrix.platform }}.txt

  release:
    needs: build-and-release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            Fortran Program ${{ steps.version.outputs.VERSION }}

            ## Downloads

            **Windows x64:** [myprogram-windows-x64.zip](myprogram-windows-x64.zip)

            **macOS ARM64 (M1):** [myprogram-macos-arm64.tar.gz](myprogram-macos-arm64.tar.gz)

            ## Build Info
            - Build date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            - Source: ${{ github.repository }}@${{ github.sha }}
          files: |
            artifacts/windows-build/myprogram-windows-x64.zip
            artifacts/macos-m1-build/myprogram-macos-arm64.tar.gz
